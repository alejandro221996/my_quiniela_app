{% extends 'base.html' %}

{% block title %}Apostar - {{ partido.equipo_local }} vs {{ partido.equipo_visitante }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <div class="max-w-4xl mx-auto py-8">
        
        <!-- Header del partido -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-8">
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 px-6 py-8 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <a href="{% url 'quinielas:partidos' %}" class="text-white hover:text-blue-200">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                            </svg>
                        </a>
                        <div>
                            <h1 class="text-2xl font-bold">Hacer Apuesta</h1>
                            <p class="text-blue-200">{{ partido.jornada.nombre }}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-blue-200">{{ partido.fecha_hora|date:"d/m/Y" }}</div>
                        <div class="text-lg font-semibold">{{ partido.fecha_hora|date:"H:i" }}</div>
                    </div>
                </div>
            </div>
            
            <!-- Equipos -->
            <div class="p-6">
                <div class="grid grid-cols-3 gap-6 items-center">
                    <!-- Equipo Local -->
                    <div class="text-center">
                        <div class="w-20 h-20 mx-auto bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center mb-3">
                            <span class="text-white text-2xl font-bold">{{ partido.equipo_local|slice:":2"|upper }}</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">{{ partido.equipo_local }}</h3>
                        <p class="text-sm text-gray-500">Local</p>
                    </div>
                    
                    <!-- VS -->
                    <div class="text-center">
                        <div class="text-3xl font-bold text-gray-400 mb-2">VS</div>
                        <div class="text-sm text-gray-500">{{ partido.estadio }}</div>
                    </div>
                    
                    <!-- Equipo Visitante -->
                    <div class="text-center">
                        <div class="w-20 h-20 mx-auto bg-gradient-to-br from-red-500 to-red-600 rounded-full flex items-center justify-center mb-3">
                            <span class="text-white text-2xl font-bold">{{ partido.equipo_visitante|slice:":2"|upper }}</span>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900">{{ partido.equipo_visitante }}</h3>
                        <p class="text-sm text-gray-500">Visitante</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulario de apuesta -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Realizar Apuesta</h2>
            
            {% if apuesta_existente %}
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                <div class="flex items-center">
                    <svg class="w-5 h-5 text-yellow-400 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span class="text-yellow-800 font-medium">Ya tienes una apuesta para este partido</span>
                </div>
                <div class="mt-2 text-sm text-yellow-700">
                    <strong>Apuesta actual:</strong> 
                    {{ partido.equipo_local }} {{ apuesta_existente.goles_local_apostados }} - {{ apuesta_existente.goles_visitante_apostados }} {{ partido.equipo_visitante }}
                    {% if apuesta_existente.puntos is not None %}
                        ({{ apuesta_existente.puntos }} puntos obtenidos)
                    {% endif %}
                </div>
                <p class="mt-1 text-sm text-yellow-600">Puedes modificarla hasta el inicio del partido.</p>
            </div>
            {% endif %}

            <form method="post" action="{% url 'quinielas:apostar' partido.pk %}" class="ajax-bet-form space-y-6" data-partido-id="{{ partido.id }}">
                {% csrf_token %}
                
                <!-- Selección de quiniela -->
                <div>
                    <label for="quiniela" class="block text-sm font-medium text-gray-700 mb-2">
                        Seleccionar Quiniela
                    </label>
                    <select name="quiniela" id="quiniela" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        <option value="">Selecciona una quiniela...</option>
                        {% for quiniela in quinielas %}
                        <option value="{{ quiniela.id }}" {% if apuesta_existente and quiniela.id == apuesta_existente.participante.quiniela.id %}selected{% elif quiniela.id == selected_quiniela %}selected{% endif %}>
                            {{ quiniela.nombre }}
                            {% if quiniela.creador == user %}(Creada por ti){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Predicción del resultado -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-4">
                        Predicción del Resultado
                    </label>
                    
                    <div class="grid grid-cols-3 gap-4 items-center">
                        <!-- Goles Local -->
                        <div class="text-center">
                            <label for="goles_local" class="block text-sm font-medium text-gray-600 mb-2">
                                {{ partido.equipo_local }}
                            </label>
                            <input type="number" 
                                   name="goles_local" 
                                   id="goles_local" 
                                   min="0" 
                                   max="20" 
                                   value="{% if apuesta_existente %}{{ apuesta_existente.goles_local_apostados }}{% else %}0{% endif %}"
                                   class="w-full px-3 py-2 text-center text-2xl font-bold border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                   required>
                        </div>
                        
                        <!-- Separador -->
                        <div class="text-center">
                            <span class="text-2xl font-bold text-gray-400">-</span>
                        </div>
                        
                        <!-- Goles Visitante -->
                        <div class="text-center">
                            <label for="goles_visitante" class="block text-sm font-medium text-gray-600 mb-2">
                                {{ partido.equipo_visitante }}
                            </label>
                            <input type="number" 
                                   name="goles_visitante" 
                                   id="goles_visitante" 
                                   min="0" 
                                   max="20" 
                                   value="{% if apuesta_existente %}{{ apuesta_existente.goles_visitante_apostados }}{% else %}0{% endif %}"
                                   class="w-full px-3 py-2 text-center text-2xl font-bold border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
                                   required>
                        </div>
                    </div>
                </div>

                <!-- Información adicional -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-blue-400 mt-0.5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                        <div class="text-sm text-blue-700">
                            <p class="font-medium mb-1">Sistema de Puntuación:</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li><strong>Resultado exacto:</strong> 3 puntos</li>
                                <li><strong>Ganador correcto:</strong> 1 punto</li>
                                <li><strong>Resultado incorrecto:</strong> 0 puntos</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Botones de acción -->
                <div class="flex justify-end space-x-4">
                    <a href="{% url 'quinielas:partidos' %}" 
                       class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                        Cancelar
                    </a>
                    <button type="submit" 
                            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 no-auto-loading"
                            data-loading="{% if apuesta_existente %}Actualizando...{% else %}Apostando...{% endif %}">
                        {% if apuesta_existente %}Actualizar Apuesta{% else %}Realizar Apuesta{% endif %}
                    </button>
                </div>
            </form>
        </div>

        <!-- Estadísticas del partido (si están disponibles) -->
        {% if partido.estadisticas %}
        <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Estadísticas del Enfrentamiento</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center p-4 bg-blue-50 rounded-lg">
                    <div class="text-2xl font-bold text-blue-600">{{ partido.estadisticas.victorias_local }}</div>
                    <div class="text-sm text-gray-600">Victorias {{ partido.equipo_local }}</div>
                </div>
                <div class="text-center p-4 bg-gray-50 rounded-lg">
                    <div class="text-2xl font-bold text-gray-600">{{ partido.estadisticas.empates }}</div>
                    <div class="text-sm text-gray-600">Empates</div>
                </div>
                <div class="text-center p-4 bg-red-50 rounded-lg">
                    <div class="text-2xl font-bold text-red-600">{{ partido.estadisticas.victorias_visitante }}</div>
                    <div class="text-sm text-gray-600">Victorias {{ partido.equipo_visitante }}</div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Debugging temporal para diagnosticar el problema
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔍 Script cargado');
    console.log('📦 Scripts disponibles:');
    console.log('  - toastManager:', typeof window.toastManager);
    console.log('  - ajaxFormHandler:', typeof window.ajaxFormHandler);
    
    const form = document.querySelector('.ajax-bet-form');
    const button = document.querySelector('button[type="submit"]');
    
    if (form) {
        console.log('📋 Formulario encontrado:', form);
        console.log('🔘 Botón encontrado:', button);
        
        // Escuchar eventos de submit
        form.addEventListener('submit', function(e) {
            console.log('🚀 Submit event detectado:', e);
            console.log('  - Default prevented:', e.defaultPrevented);
        });
        
        // Escuchar clicks en el botón
        if (button) {
            button.addEventListener('click', function(e) {
                console.log('👆 Button click detectado:', e);
                console.log('  - Button disabled:', this.disabled);
                console.log('  - Button classes:', this.className);
                
                // Verificar si el botón es de tipo submit
                console.log('  - Button type:', this.type);
                
                // Verificar el formulario padre
                console.log('  - Parent form:', this.form);
                
                // Test: disparar submit manualmente
                console.log('🔥 Disparando submit manualmente...');
                if (this.form) {
                    const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                    this.form.dispatchEvent(submitEvent);
                }
            });
        }
        
        // Test manual del AJAX handler
        setTimeout(() => {
            if (window.ajaxFormHandler) {
                console.log('🧪 Testeando AJAX handler manualmente...');
                
                // Simular submit event
                const submitEvent = new Event('submit', { bubbles: true, cancelable: true });
                Object.defineProperty(submitEvent, 'target', { value: form });
                
                // Verificar si el handler captura el evento
                if (form.matches('.ajax-bet-form')) {
                    console.log('✅ Formulario coincide con selector .ajax-bet-form');
                } else {
                    console.log('❌ Formulario NO coincide con selector .ajax-bet-form');
                }
            }
        }, 1000);
    }
});
</script>
{% endblock %}
